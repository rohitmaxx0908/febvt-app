<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .status {
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }

        .success {
            background: #d4edda;
            border-color: #28a745;
        }

        .error {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .warning {
            background: #fff3cd;
            border-color: #ffc107;
        }

        pre {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>üîç Supabase Connection Diagnostic</h1>

    <div id="results"></div>

    <button onclick="runTests()">Run Tests</button>
    <button onclick="location.reload()">Refresh</button>

    <script type="module">
        import { supabase } from './src/lib/supabase.ts';

        window.supabase = supabase;

        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Running tests...</p>';

            let html = '';

            // Test 1: Check environment variables
            html += '<div class="status ' + (import.meta.env.VITE_SUPABASE_URL ? 'success' : 'error') + '">';
            html += '<h3>‚úì Environment Variables</h3>';
            html += '<pre>URL: ' + (import.meta.env.VITE_SUPABASE_URL || '‚ùå MISSING') + '</pre>';
            html += '<pre>Key: ' + (import.meta.env.VITE_SUPABASE_ANON_KEY ? '‚úÖ Present' : '‚ùå MISSING') + '</pre>';
            html += '</div>';

            if (!import.meta.env.VITE_SUPABASE_URL || !import.meta.env.VITE_SUPABASE_ANON_KEY) {
                html += '<div class="status error">';
                html += '<h3>‚ùå Missing Credentials</h3>';
                html += '<p>Please check your .env file and restart the dev server.</p>';
                html += '</div>';
                results.innerHTML = html;
                return;
            }

            // Test 2: Check table exists
            try {
                const { data, error } = await supabase
                    .from('wishes')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.message.includes('does not exist')) {
                        html += '<div class="status error">';
                        html += '<h3>‚ùå Table Does Not Exist</h3>';
                        html += '<p>Please run the SQL schema in your Supabase dashboard.</p>';
                        html += '<pre>' + error.message + '</pre>';
                        html += '</div>';
                    } else {
                        html += '<div class="status error">';
                        html += '<h3>‚ùå Database Error</h3>';
                        html += '<pre>' + JSON.stringify(error, null, 2) + '</pre>';
                        html += '</div>';
                    }
                } else {
                    html += '<div class="status success">';
                    html += '<h3>‚úì Table Exists</h3>';
                    html += '<p>The wishes table is accessible!</p>';
                    html += '</div>';

                    // Test 3: Try insert
                    const testData = {
                        from_name: 'Test',
                        to_name: 'Test',
                        data: { from: 'Test', to: 'Test', message: 'Test', firstMeet: '', firstImpression: '', favQuality: '', ourSong: '', cuteHabit: '', memory: '', reason: '', proposalStory: '', future: '', promise: '', images: [], imageCaptions: [] }
                    };

                    const { data: insertData, error: insertError } = await supabase
                        .from('wishes')
                        .insert([testData])
                        .select()
                        .single();

                    if (insertError) {
                        html += '<div class="status error">';
                        html += '<h3>‚ùå Insert Failed</h3>';
                        html += '<pre>' + JSON.stringify(insertError, null, 2) + '</pre>';
                        html += '</div>';
                    } else {
                        html += '<div class="status success">';
                        html += '<h3>‚úì Insert Successful</h3>';
                        html += '<p>Created test record with ID: ' + insertData.id + '</p>';
                        html += '</div>';

                        // Clean up
                        await supabase.from('wishes').delete().eq('id', insertData.id);

                        html += '<div class="status success">';
                        html += '<h3>üéâ All Tests Passed!</h3>';
                        html += '<p>Your Supabase connection is working perfectly!</p>';
                        html += '</div>';
                    }
                }
            } catch (err) {
                html += '<div class="status error">';
                html += '<h3>‚ùå Unexpected Error</h3>';
                html += '<pre>' + err.toString() + '</pre>';
                html += '</div>';
            }

            results.innerHTML = html;
        }

        window.runTests = runTests;

        // Auto-run on load
        runTests();
    </script>
</body>

</html>